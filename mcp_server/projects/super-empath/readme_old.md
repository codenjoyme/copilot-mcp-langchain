# Super Empath - Эмоциональный переводчик для отношений

## Описание проекта

**Super Empath** - это Telegram-бот, который служит посредником в общении между людьми в отношениях, помогая переформулировать сообщения более мягко и конструктивно.

## Как это работает

### Процесс коммуникации:
1. **Отправитель** пишет сообщение (например: "та ты достала меня критиковать, я уже устал")
2. **Бот** обрабатывает сообщение через LLM и предлагает более мягкую версию
3. # Проект Super-Empath

## Описание
Super-Empath - это интеллектуальный Telegram-бот для улучшения коммуникации в отношениях. Бот помогает парам и группам людей формулировать свои мысли более мягко и конструктивно, предотвращая конфликты и недопонимания.

## Концепция

### Проблема
В отношениях люди часто говорят вещи, которые ранят или триггерят партнера, не осознавая этого. Эмоциональные реакции приводят к конфликтам, которые можно было бы избежать с более продуманной формулировкой.

### Решение
Бот выступает в роли "эмоционального переводчика", который:
1. Принимает сообщение от отправителя
2. Анализирует его через LLM с системными промптами
3. Предлагает более мягкую и конструктивную формулировку
4. Позволяет отправителю корректировать предложение
5. Отправляет финальную версию получателю(ям)

## Workflow

### Отправка сообщения
1. **Пользователь пишет:** "та ты достала меня критиковать, я уже устал"
2. **Бот анализирует** и предлагает: "Я чувствую усталость от критики, можем обсудить это по-другому?"
3. **Пользователь может:**
   - Написать "тамам" → сообщение отправляется
   - Попросить изменения → бот предлагает новые варианты
   - Написать "отбой" → отменить отправку

### Получение ответа
1. **Получатель видит** отфильтрованное сообщение
2. **Отвечает** (возможно, тоже эмоционально)
3. **Бот обрабатывает** ответ аналогично
4. **Цикл повторяется** для здорового диалога

## Архитектура

### Компоненты
1. **lng_telegram_polling_server** - транспортный слой (Telegram API)
2. **lng_llm_rag_search** - обработка сообщений через LLM
3. **lng_llm_prompt_template** - системные промпты для эмпатии
4. **lng_batch_run** - оркестрация pipeline обработки

### Данные
- **Сессии** - группы пользователей (2-N человек)
- **Контекст** - история переписки для лучшего понимания
- **Состояния** - отслеживание процесса обработки сообщений

## Технические особенности

### Управление сессиями
- **Создание:** первый пользователь получает UUID-ссылку
- **Присоединение:** другие переходят по ссылке с UUID
- **Масштабирование:** поддержка групп 2-N человек

### Обработка сообщений
- **Команды:**
  - "тамам" - одобрить и отправить
  - "отбой" - отменить обработку
  - Обычный текст - запрос на улучшение формулировки

### LLM интеграция
- **Системные промпты** для эмпатичной коммуникации
- **RAG база** с примерами хорошей и плохой коммуникации
- **Контекстная память** для понимания отношений

## Примеры использования

### Семейная пара
```
Он: "ты опять потратила кучу денег на ерунду"
Бот: "Предлагаю: 'Я беспокоюсь о наших расходах, можем обсудить бюджет?'"
Он: "тамам"
→ Ей приходит мягкая версия
```

### Рабочая команда
```
A: "этот код полное говно, кто это писал?"
Бот: "Предлагаю: 'В коде есть проблемы, давайте их обсудим и улучшим'"
A: "можно жестче"
Бот: "Как насчет: 'Код требует серьезного рефакторинга для повышения качества'"
A: "тамам"
→ Команде приходит конструктивный фидбек
```

## Roadmap

### MVP (Phase 1)
- [x] Telegram бот с поддержкой сессий
- [ ] Базовая LLM обработка сообщений
- [ ] Простые системные промпты
- [ ] Workflow "предложение → корректировка → отправка"

### Enhanced (Phase 2)
- [ ] RAG база примеров коммуникации
- [ ] Контекстная память диалогов
- [ ] Персонализация под конкретные пары/группы
- [ ] Аналитика качества коммуникации

### Advanced (Phase 3)
- [ ] Эмоциональный анализ тона
- [ ] Предиктивные предупреждения о конфликтах
- [ ] Интеграция с календарем и настроением
- [ ] Коучинг-рекомендации для улучшения отношений

## Технический стек

### Backend
- **Python** + **LangChain** для LLM
- **python-telegram-bot** для Telegram API
- **MCP Server** для инфраструктуры

### AI/ML
- **Azure OpenAI** / **OpenAI GPT-4**
- **Vector DB** для RAG (ChromaDB/Pinecone)
- **Embedding models** для семантического поиска

## Деплоймент

### Development
- Локальный запуск через `lng_telegram_polling_server`
- Тестирование с реальными Telegram аккаунтами

### Production
- Webhook режим для лучшей производительности
- Cloud hosting (AWS/Azure/GCP)
- Мониторинг и логирование

## Этические соображения

### Приватность
- Сообщения обрабатываются локально или в доверенном облаке
- Опциональное шифрование истории диалогов
- Пользователи контролируют свои данные

### Прозрачность
- Пользователи знают, что сообщения обрабатываются ботом
- Возможность отключить фильтрацию
- Открытый исходный код для доверия

## Заключение

Super-Empath представляет новый подход к цифровой коммуникации, где технология помогает людям лучше понимать друг друга и строить более здоровые отношения.
4. **Одобренное сообщение** отправляется всем участникам сессии
5. **Получатель** отвечает, и процесс повторяется

### Управление сессиями:
- **Создание сессии**: Первый пользователь подключается к боту и получает ссылку-приглашение с UUID
- **Присоединение**: Другие пользователи переходят по ссылке и автоматически присоединяются к сессии
- **Групповое общение**: Поддержка 2-N участников в одной сессии

### Команды управления:
- **"тамам"** - одобрить и отправить текущую версию сообщения всем участникам
- **"отбой"** - отменить текущую обработку сообщения
- Любой другой текст - запрос на обработку/корректировку сообщения

### Требования к ответам:
- Избегать "пластиковых" формулировок
- Не использовать букву "ё" (заменять на "е")
- Использовать короткие тире "-" вместо длинных
- Учитывать возражения пользователя на предыдущие предложения
- Предлагать варианты через "я-сообщения"

## Архитектура

### Компоненты:
1. **lng_telegram_polling_server** - транспортный слой (прием/отправка сообщений)
2. **Бизнес-логика обработки** - LLM + RAG для контекста беседы
3. **Управление сессиями** - хранение состояний пользователей и сессий

### Технологии:
- **Telegram Bot API** (polling)
- **LangChain** для LLM-обработки
- **RAG** для контекста беседы
- **UUID** для уникальных сессий
- **Pipeline система** для интеграции компонентов

## Пример использования

```
1. Алиса подключается к боту → получает ссылку https://t.me/superempathbot?start=550e8400-e29b-41d4-a716-446655440000

2. Боб переходит по ссылке → присоединяется к сессии с Алисой

3. Алиса пишет: "Ты опять забыл про мои планы!"
   Бот предлагает: "Я расстроена, что мои планы не были учтены. Можем обсудить?"
   Алиса: "тамам"

4. Боб получает обработанное сообщение и отвечает через тот же процесс
```

### Промпт для LLM:
```
Ты супер эмпат, твоя задача помочь собеседникам договориться. Ты будешь видеть их сообщения и тревогу и размышления твоего клиента. 

Пожалуйста отвечай ему так, чтобы он получил ответ из трех составляющих: 
1) Почему не стоит писать как написал он, почему это рисковано или заботливо ответь на его возражения 
2) Как стоит написать чтобы передать мысль через я сообщение - твой один вариант ответа. 

Если он возражает на твое прошлое предложение, то учти его возражения и предложи новый вариант. 

Структура ответа такая 
"""
{
   "explanation":"Твои размышления на тему",
   "suggestion":"То как ты предлагаешь ответить в этой итерации"    
}
"""

Прошу не используй символы "е" вместо этого "е" и больших дефисов, вместо них "-". Так твои сообщения не должны выглядеть пластиковыми.

История переписки: 
"""
{conversation_history}
"""

Сообщение пользователя: 
"""
{user_message}
"""

ID клиента для идентификации: "{user_id}"
```

## Техническая архитектура (LLM Integration)

### Компоненты системы:
1. **lng_telegram_polling_server** - транспортный слой Telegram API
2. **lng_telegram_super_empath** - бизнес-логика эмпатической обработки
3. **lng_llm_prompt_template** - управление промптами для LLM
4. **lng_batch_run** - пайплайн оркестрации

### Управление историей:
- **Путь хранения**: `config/telegram/sessions/<sessionId>/<userId>.txt`
- **Формат истории**: `[USER_ID|USER_NAME]: message content`
- **Контекст**: каждый пользователь видит свою персональную историю + сообщения других участников

### LLM интеграция:
- **Промпт темплейт**: `default_super_empath`
- **Параметры**: `{conversation_history}`, `{user_message}`, `{user_id}`
- **Структурированный вывод**: JSON с полями `explanation` и `suggestion`
- **Контекст**: полная история переписки для каждого пользователя
- **Интеграция**: через `tool_registry.py` → `lng_llm_prompt_template use`

### Формат истории переписки:
```
[123456789|Алиса]: Привет, как дела?
[987654321|Боб]: Хорошо, а у тебя?
[EMPATH]: Я предлагаю ответить: "Спасибо, что спросил. У меня тоже все хорошо."
[123456789|Алиса]: тамам
```

### Pipeline конфигурация:
```json
{
  "operation": "start",
  "pipeline": [
    // 1. Загрузка промпта из файла
    // 2. Сохранение промпта как template
    // 3. Вызов telegram super-empath tool
  ]
}
```

## Статус разработки

- ✅ Проектирование архитектуры
- ✅ Базовая telegram polling система с именованными ботами
- ✅ **LLM интеграция завершена**
  - ✅ Документация и декомпозиция задач
  - ✅ Создание промпт темплейта с JSON выводом
  - ✅ Обновление pipeline конфигурации с pipeline_file подходом
  - ✅ Система управления историей в файлах
  - ✅ Интеграция с LLM через tool_registry
  - ✅ Именованные боты для избежания конфликтов
  - ✅ Тестирование полного цикла работы

## Текущие возможности

### Полностью работающий функционал:
- **Создание и управление сессиями** - уникальные UUID ссылки для приглашений
- **LLM-обработка сообщений** - замена захардкоженной логики на контекстуальные ответы
- **История переписки** - сохранение в формате `[USER_ID|USER_NAME]: message` 
- **Структурированный вывод** - JSON с полями `explanation` и `suggestion`
- **Команды управления** - `тамам` (одобрить), `отбой` (отменить)
- **Именованные боты** - избежание конфликтов при multiple instances
- **Детальная отчетность** - полное отображение отправленных сообщений

### Технические особенности:
- **Pipeline_file подход** - корректная обработка expressions с telegram контекстом
- **Автоматическая очистка** - старые экземпляры ботов при запуске новых
- **Graceful error handling** - fallback на базовую логику при сбоях LLM
- **Контекстуальность** - LLM видит полную историю переписки каждого пользователя

## Файлы проекта

- `readme.md` - описание проекта и архитектуры ✅
- `tasklist.md` - декомпозиция задач разработки ✅ 
- `super-empath-bot.agent.md` - инструкции по запуску бота ✅
- `examples.md` - примеры использования и диалогов ✅
- `config/telegram_pipeline.json` - конфигурация batch пайплайна ✅
- `config/message_pipeline.json` - конфигурация обработки сообщений ✅
- `prompt/default_super_empath.txt` - промпт темплейт для LLM ✅
- `../../tools/lng_telegram_super_empath/` - основной инструмент ✅

## Запуск проекта

### Быстрый старт:
```bash
# 1. Перезапустить MCP сервер
Get-Process python* | Where-Object { $_.ProcessName -like "*python*" } | Stop-Process -Force

# 2. Запустить через MCP инструмент lng_batch_run:
{
  "pipeline_file": "mcp_server/projects/super-empath/config/telegram_pipeline.json"  
}

# 3. Проверить статус:
{
  "operation": "status",
  "bot_name": "super_empath"
}
```

### Требования:
- Переменная окружения `TELEGRAM_BOT_TOKEN` с токеном бота
- Доступ к Azure OpenAI или OpenAI API для LLM
- Рабочий MCP сервер

**Подробные инструкции:** См. `super-empath-bot.agent.md`  
**Примеры использования:** См. `examples.md`
